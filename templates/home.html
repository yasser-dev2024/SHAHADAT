<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø´Ù‡Ø§Ø¯Ø§ØªÙƒ Ø¨ÙŠÙ† ÙŠØ¯ÙŠÙƒ</title>
  <style>
    body { margin:0; font-family:'Tahoma',sans-serif; background:#fffafc; }
    .container { padding:30px; max-width:1200px; margin:auto; }
    h2 { text-align:center; color:#ff6f91; margin-bottom:30px; font-size:28px; }

    .grid {
      display:grid;
      grid-template-columns:repeat(auto-fill,minmax(220px,1fr));
      gap:20px;
    }
    .card {
      background:#fff; border-radius:12px; overflow:hidden;
      box-shadow:0 4px 10px rgba(0,0,0,0.1);
      transition:transform 0.3s; cursor:pointer;
    }
    .card:hover { transform:translateY(-5px); }
    .card img { width:100%; height:150px; object-fit:cover; }
    .card h3 { margin:0; padding:15px; text-align:center; font-size:18px; color:#333; }

    .preview {
      margin:40px auto; max-width:900px; position:relative; display:none; text-align:center;
    }
    .preview img { width:100%; border-radius:12px; }

    .editable {
      position:absolute;
      cursor:grab;
      font-family:'Cairo',sans-serif;
      font-weight:bold;
      color:#000;
      user-select:none;
      text-shadow:0 1px 2px rgba(0,0,0,0.2);
    }

    .lock-badge {
      position:absolute;
      top:50%;
      left:50%;
      transform:translate(-50%,-50%) rotate(-30deg);
      background:rgba(255,0,0,0.35);
      color:white;
      font-size:22px;
      font-weight:bold;
      padding:18px 40px;
      border-radius:10px;
      z-index:20;
      user-select:none;
      text-shadow:1px 1px 3px rgba(0,0,0,0.3);
      pointer-events:none;
    }

    .form-area { text-align:center; margin:20px; display:none; }
    .form-area input, .form-area select, .form-area button {
      margin:6px; padding:8px; border:1px solid #ccc; border-radius:6px;
    }
    .form-area button {
      background:#ff6f91; color:white; font-size:16px; cursor:pointer; transition:0.3s;
    }
    .form-area button:hover { background:#ff3b6f; }

    /* ğŸ”¹ Ø§Ù„Ø´Ø¹Ø§Ø± Ø§Ù„Ù‚Ø§Ø¨Ù„ Ù„Ù„ØªØ­Ø±ÙŠÙƒ */
    #customLogo {
      position:absolute;
      top:30px;
      right:30px;
      width:120px;
      opacity:0.9;
      display:none;
      z-index:10;
      cursor:grab;
      user-select:none;
      border:none;
    }

    /* ğŸ”¹ Ù…Ù‚Ø¨Ø¶ Ø§Ù„ØªÙƒØ¨ÙŠØ± */
    #resizeHandle {
      position:absolute;
      width:18px;
      height:18px;
      bottom:-10px;
      right:-10px;
      background:rgba(255,255,255,0.5);
      border-radius:4px;
      cursor:se-resize;
      display:none;
      z-index:15;
    }
  </style>
</head>
<body>

{% include "header.html" %}

<div class="container">
  <h2>ğŸŒ¸ Ù‚ÙˆØ§Ù„Ø¨ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© ğŸŒ¸</h2>

  <div style="text-align:center;">
    {% for category in categories %}
      <button onclick="toggleCategory('{{ category.id }}')" style="margin:8px; padding:10px 20px; background:#ffe1ec; border:none; border-radius:8px; cursor:pointer; font-size:18px;">ğŸ“ {{ category.name }}</button>
    {% endfor %}
  </div>

  {% for category in categories %}
    <div id="category-{{ category.id }}" class="grid" style="display:none; margin-top:25px;">
      {% for template in category.templates.all %}
      <div class="card" onclick="selectCert('{{ template.background.url }}')">
        <img src="{{ template.background.url }}" alt="{{ template.title }}">
        <h3>{{ template.title }}</h3>
      </div>
      {% empty %}
      <p style="text-align:center;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚ÙˆØ§Ù„Ø¨ Ø­Ø§Ù„ÙŠØ§Ù‹ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„ØªØµÙ†ÙŠÙ ğŸŒ·</p>
      {% endfor %}
    </div>
  {% endfor %}

  <div id="preview" class="preview">
    <img id="previewImg" src="" alt="Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©">

    <!-- ğŸ”¹ Ø§Ù„Ø´Ø¹Ø§Ø± -->
    <img id="customLogo" src="">
    <div id="resizeHandle"></div>

    <div id="studentName" class="editable" style="top:38%;left:25%;">[Ø§Ù„Ø§Ø³Ù…]</div>
    <div id="certificateText" class="editable" style="top:47%;left:15%;width:70%;text-align:center;">[Ù†Øµ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©]</div>
    <div id="schoolName" class="editable" style="top:65%;left:25%;">[Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø£Ùˆ Ø§Ù„Ù…Ù†Ø´Ø£Ø©]</div>
    <div id="positionTitle" class="editable" style="top:78%;left:25%;">[ØµÙØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹]</div>
    <div id="managerName" class="editable" style="top:83%;left:25%;">[Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹]</div>

    <div id="lockBadge" class="lock-badge">ğŸ”’ Ø§Ø·Ù„Ø¨ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¢Ù† Ù„ØªØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„ØªÙ†Ø²ÙŠÙ„</div>
  </div>

  <div id="formInputs" class="form-area">
    <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨" oninput="updateText('studentName', this.value)">
    <input type="text" placeholder="Ù†Øµ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©" oninput="updateText('certificateText', this.value)" style="width:300px;">
    <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ø£Ùˆ Ø§Ù„Ù…Ù†Ø´Ø£Ø©" oninput="updateText('schoolName', this.value)">
    <input type="text" placeholder="ØµÙØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹" oninput="updateText('positionTitle', this.value)">
    <input type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…ÙˆÙ‚Ø¹" oninput="updateText('managerName', this.value)">
    <br>
    <label>ğŸ¨ Ø§Ù„Ù„ÙˆÙ†:</label> <input type="color" id="textColor" value="#000000">
    <label>ğŸ”  Ø§Ù„Ø­Ø¬Ù…:</label> <input type="number" id="fontSize" value="22" min="10" max="60">
    <label>ğŸ–‹ï¸ Ø§Ù„Ø®Ø·:</label>
    <select id="fontFamily">
      <option value="Cairo">Cairo</option>
      <option value="Tahoma">Tahoma</option>
      <option value="Arial">Arial</option>
      <option value="Times New Roman">Times New Roman</option>
      <option value="Amiri">Amiri</option>
    </select>
    <br><br>

    <label>ğŸ–¼ï¸ Ø£Ø¶Ù Ø´Ø¹Ø§Ø±Ùƒ:</label>
    <input type="file" id="logoUploader" accept="image/*">
    <label>ğŸŒ«ï¸ Ø§Ù„Ø´ÙØ§ÙÙŠØ©:</label>
    <input type="range" id="logoOpacity" min="0.1" max="1" step="0.1" value="0.9">
    <br><br>

    <button onclick="requestCode()">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© / ØªÙ†Ø²ÙŠÙ„</button>
  </div>
</div>

{% include "footer.html" %}

<script>
function toggleCategory(id) {
  document.querySelectorAll('[id^="category-"]').forEach(div => div.style.display = 'none');
  document.getElementById(`category-${id}`).style.display = 'grid';
}

function selectCert(imgUrl) {
  document.getElementById('preview').style.display = 'block';
  document.getElementById('formInputs').style.display = 'block';
  document.getElementById('previewImg').src = imgUrl;
}

function updateText(target, value) {
  document.getElementById(target).innerText = value || `[${target}]`;
}

document.getElementById('textColor').oninput = function() {
  document.querySelectorAll('.editable').forEach(el => el.style.color = this.value);
};
document.getElementById('fontSize').oninput = function() {
  document.querySelectorAll('.editable').forEach(el => el.style.fontSize = this.value + 'px');
};
document.getElementById('fontFamily').onchange = function() {
  document.querySelectorAll('.editable').forEach(el => el.style.fontFamily = this.value);
};

// ğŸ–¼ï¸ Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø´Ø¹Ø§Ø±
const logo = document.getElementById('customLogo');
const handle = document.getElementById('resizeHandle');
const opacitySlider = document.getElementById('logoOpacity');

document.getElementById('logoUploader').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    logo.src = ev.target.result;
    logo.style.display = 'block';
    handle.style.display = 'block';
  };
  reader.readAsDataURL(file);
});

opacitySlider.addEventListener('input', e => {
  logo.style.opacity = e.target.value;
});

// ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø´Ø¹Ø§Ø± Ø¨Ø­Ø±ÙŠØ©
let dragging = false, resizing = false;
let startX, startY, startLeft, startTop, startWidth;

logo.addEventListener('pointerdown', e => {
  dragging = true;
  startX = e.clientX;
  startY = e.clientY;
  const rect = logo.getBoundingClientRect();
  const parentRect = logo.offsetParent.getBoundingClientRect();
  startLeft = rect.left - parentRect.left;
  startTop = rect.top - parentRect.top;
  startWidth = logo.offsetWidth;
  logo.setPointerCapture(e.pointerId);
  logo.style.cursor = 'grabbing';
});

document.addEventListener('pointermove', e => {
  if (dragging) {
    const dx = e.clientX - startX;
    const dy = e.clientY - startY;
    logo.style.left = (startLeft + dx) + 'px';
    logo.style.top = (startTop + dy) + 'px';
  }
  if (resizing) {
    const dx = e.clientX - startX;
    logo.style.width = (startWidth + dx) + 'px';
  }
});

document.addEventListener('pointerup', e => {
  dragging = false;
  resizing = false;
  logo.style.cursor = 'grab';
  logo.releasePointerCapture?.(e.pointerId);
});

// âœ… Ø§Ù„Ø³Ø­Ø¨ Ù„ØªÙƒØ¨ÙŠØ± Ù…Ù† Ø§Ù„Ø²Ø§ÙˆÙŠØ©
handle.addEventListener('pointerdown', e => {
  resizing = true;
  startX = e.clientX;
  startWidth = logo.offsetWidth;
  e.stopPropagation();
});
document.addEventListener('pointermove', e => {
  if (resizing) {
    const dx = e.clientX - startX;
    logo.style.width = (startWidth + dx) + 'px';
  }
});
document.addEventListener('pointerup', () => resizing = false);

// âœ… Ø³Ø­Ø¨ Ø§Ù„Ù†ØµÙˆØµ
let activeEl = null, startX2 = 0, startY2 = 0, startLeft2 = 0, startTop2 = 0;
document.addEventListener('pointerdown', e=>{
  if (!e.target.classList.contains('editable')) return;
  activeEl = e.target;
  startX2 = e.clientX; startY2 = e.clientY;
  const rect = activeEl.getBoundingClientRect();
  startLeft2 = rect.left - activeEl.offsetParent.getBoundingClientRect().left;
  startTop2 = rect.top - activeEl.offsetParent.getBoundingClientRect().top;
  activeEl.setPointerCapture(e.pointerId);
  activeEl.style.cursor = 'grabbing';
});
document.addEventListener('pointermove', e=>{
  if (!activeEl) return;
  const dx = e.clientX - startX2, dy = e.clientY - startY2;
  activeEl.style.left = (startLeft2 + dx) + 'px';
  activeEl.style.top = (startTop2 + dy) + 'px';
});
document.addEventListener('pointerup', e=>{
  if (activeEl) {
    activeEl.releasePointerCapture(e.pointerId);
    activeEl.style.cursor = 'grab';
    activeEl = null;
  }
});

// âœ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯
async function requestCode() {
  let code = prompt("ğŸ”‘ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ÙˆØµÙˆÙ„ Ù‚Ø¨Ù„ Ø§Ù„ØªÙ†Ø²ÙŠÙ„:");
  if(!code) return alert("âŒ Ù„Ù… ÙŠØªÙ… Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø±Ù…Ø².");
  try {
    const response = await fetch(`/commerce/validate-code/${code}/`);
    const data = await response.json();
    if (data.valid) {
      document.getElementById('lockBadge').style.display = 'none';
      alert(`âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ø¨Ù†Ø¬Ø§Ø­! ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø¢Ù† ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©.\nğŸ”¢ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${data.remaining}`);
    } else if (data.reason === 'limit_reached') {
      alert("âš ï¸ Ø§Ù†ØªÙ‡Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ø±Ù…Ø².");
    } else {
      alert("âŒ Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ§Ù„Ø­.");
    }
  } catch {
    alert("âš ï¸ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„.");
  }
}
</script>

</body>
</html>
